<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: "en" }}">

  {%- include head.html -%}

  <body>

    {%- include header.html -%}

    <div class="flex" aria-label="Content">
      <div class="container herounit">
        <div class="flex flex--vertical content">
          <h3 class="flex">Cylc (“silk”) is a workflow engine for cycling systems</h3>
					<p>Cylc was originally developed for use in environmental forecasting
					at <a href="http://www.niwa.co.nz/">NIWA</a>, but it is not actually
							specialized to forecasting. It is now an Open Source
			collaboration involving NIWA, <a href="http://www.metoffice.gov.uk/">Met
			Office</a>, and <a
	href="https://github.com/cylc/cylc-flow/blob/master/CONTRIBUTING.md#code-contributors">others</a>,
	available under the <a href="{{'/license' | relative_url}}">GPL v3 license</a>.</p>
        </div>
        <div class="flex flex--vertical release jc-space-around">
            <div class="flex flex--vertical">
          <div class="flex download-buttons">
            <div class="flex flex--vertical m-r">
              <label>Production</label>
              <a class="flex grow" id="cylc7-button">
                <button class="button flex grow">
                    <img src={{'/assets/icon-download.svg' | relative_url}} />
                    <span id="cylc7-latest-release-name"></span>
                </button>
              </a>
              <label id="cylc7-latest-release-pubdate-text"></label>
            </div>
            <div class="flex flex--vertical m-l">
                <label>Preview</label>
                <a class="flex grow" id="cylc8-button">
                  <button class="button flex grow">
                    <img src={{'/assets/icon-download.svg' | relative_url}} />
                    <span id="cylc8-latest-release-name"></span>
                  </button>
                </a>
                <label id="cylc8-latest-release-pubdate-text"></label>
              </div>
          </div>

              <h3 class="flex jc-center">Next Release:&nbsp;
                <a class="page-link" id="milestone-url" target="_blank"><span id="milestone-version"></span> (<span id="progress-info"></span>)</a>
              </h3>
              <div class="flex">
                <div class="progressbar" id="milestone-container">
                  <div class="progress" id="progress"></div>
                  <div class="flex label jc-space-between">
                    <span>0%</span>
                    <span>100%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
      </div>
    </div>

    <div class="flex usecase bg-grey">
      <div class="container flex--vertical">
        <div class="flex">
          <h3>Use Cases for Cycling</h3>
        </div>

        <div class="flex wrap">
          <div class="flex flex--vertical">
            <div class="flex item">
                <li>Running successive cycles of an environmental forecasting system.</li>
            </div>
            <div class="flex item">
                <li>Splitting long model integrations into many smaller chunks, with associated processing tasks for each chunk.</li>
              </div>
          </div>

          <div class="flex flex--vertical">
              <div class="flex item">
                  <li>Running successive steps in some multi-task iterative process, such as for optimizing model parameters.</li>
              </div>
              <div class="flex item">
                <li>Processing a series of datasets (potentially concurrently, to the extent possible) as they are generated or received.</li>
                </div>
            </div>
        </div>
      </div>
    </div>

    <div class="flex secondary">
        <div class="container flex--vertical">
          <div class="flex wrap">
            <div class="flex flex--vertical">
              <div class="flex item">
                  <img src={{'/assets/icon-workflow.svg' | relative_url}} class="icon-workflow" alt="Workflow Icon"/>
                  <div class="flex">Workflows are configured in a human-readable text format, with programmatic templating - so you can use software development power tools for workflow development.</div>
              </div>
              <div class="flex item">
                  <img src={{'/assets/icon-workflow.svg' | relative_url}} class="icon-workflow" alt="Workflow Icon"/>
                  <div class="flex">Scheduling is configured with an efficient cycling graph notation, and task runtime properties with an efficient inheritance hierarchy.</div>
              </div>

              <div class="flex item">
                  <img src={{'/assets/icon-workflow.svg' | relative_url}} class="icon-workflow" alt="Workflow Icon"/>
                  <div class="flex">Cylc respects inter-cycle dependence and is not constrained by a traditional global cycle loop, so cycles can interleave naturally for fast scheduling after delays, and for 'off the clock' operation.</div>
              </div>
              <div class="flex item">
                  <img src={{'/assets/icon-workflow.svg' | relative_url}} class="icon-workflow" alt="Workflow Icon"/>
                  <div class="flex">Cylc has low admin overhead and a small security footprint, because there is no central server process to manage workflows for all users.</div>
              </div>
              <div class="flex item">
                  <img src={{'/assets/icon-workflow.svg' | relative_url}} class="icon-workflow" alt="Workflow Icon"/>
                  <div class="flex">Plus many other features to support both clock-triggered real time and free-flow scheduling in research and operational environments.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="flex">
        <div class="container flex--vertical">
          <p>If you use Cylc to automate your workflows, <a href="https://cylc.github.io/documentation/#publications-citations-and-references">please cite Cylc in your publications.</a></p>
          <p><a href="mailto:hilary.oliver@niwa.co.nz">Let us know</a> if your organization can be <a href={{'/users' | relative_url}}>listed as a Cylc user</a> on this site.</p>
        </div>
      </div>

      <div class="flex users">
          <div class="container flex--vertical">
            <div class="flex wrap">
              <div class="flex flex--vertical">
                <div class="flex item wrap">
                    <a href={{'/users' | relative_url}}>
                      <img src={{'/assets/icon-metoffice.svg' | relative_url}} class="icon-user met" alt="Met Office"/>
                      <img src={{'/assets/icon-airforce.png' | relative_url}} class="icon-user airforce" alt="Air Force"/>
                      <img src={{'/assets/icon-altair.jpeg' | relative_url}} class="icon-user altair" alt="Altair"/>
                      <img src={{'/assets/icon-agbom.jpeg' | relative_url}} class="icon-user agbom" alt="AGBOM"/>
                      <img src={{'/assets/icon-csiro.png' | relative_url }} class="icon-user csiro" alt="CSIRO"/>
                      <img src={{'/assets/icon-moes.jpeg' | relative_url}} class="icon-user moes" alt="MOES"/>
                      <img src={{'/assets/icon-esiwace.png' | relative_url}} class="icon-user esiwace" alt="ESIWACE"/>
                      <img src={{'/assets/icon-icm.png' | relative_url}} class="icon-user icm" alt="ICM"/>
                      <img src={{'/assets/icon-korea.png' | relative_url}} class="icon-user korea" alt="Korea"/>
                      <img src={{'/assets/icon-coecss.png' | relative_url}} class="icon-user coecss" alt="COECSS"/>
                      <img src={{'/assets/icon-mets.png' | relative_url}} class="icon-user mets" alt="METS"/>
                      <img src={{'/assets/icon-niwa.png' | relative_url}} class="icon-user niwa" alt="NIWA"/>
                      <img src={{'/assets/icon-saws.jpeg' | relative_url}} class="icon-user saws" alt="SAWS"/>
                      <img src={{'/assets/icon-isenes.png' | relative_url}} class="icon-user isenes" alt="ISENES"/>
                      <img src={{'/assets/icon-ncfas.png' | relative_url}} class="icon-user ncfas" alt="NCFAS"/>
                    </a>
                </div>
              </div>
            </div>
          </div>
        </div>

    {%- include header.html -%}
    <script type="text/javascript">
      "use strict";

      // --- HTTP request
      /**
       * The GitHub URL for the milestones.
       * @const {string}
       */
      const MILESTONES_URL = "https://api.github.com/repos/cylc/cylc/milestones";
      /**
       * The GitHub URL for the releases.
       * @const {string}
       */
      const RELEASES_URL   = "https://api.github.com/repos/cylc/cylc/releases";
      /**
       * The GitHub URL for the tags.
       * @const {string}
       */
      const TAGS_URL = "https://github.com/cylc/cylc-flow/releases/tag/";
      /**
       * Send HTTP GET request, and invoke callback after upon response. If
       * it contains the GitHub API message, the callback is not invoked, but
       * instead it is logged ot the console as an error.
       * @param {string} url - The URL to send GET request.
       * @return {Promise} A promise.
       */
      function doGet (url) {
        return new Promise(function(resolve, reject) {
          const xhr = new XMLHttpRequest();
          xhr.open("GET", url);
          xhr.onload = function () {
            const milestones = JSON.parse(this.response);
            // GitHub API returns {documentation_url: "", message: ""} messages for rate limiting
            // see https://developer.github.com/v3/#rate-limiting
            // and https://github.com/cylc/cylc.github.io/issues/15
            if (Object.prototype.hasOwnProperty.call(milestones, 'message')) {
              // will be logged in the .catch block of the promise call
              reject(milestones.message);
            } else {
              resolve(milestones);
            }
          };
          xhr.onerror = function () {
            reject(xhr.statusText);
          };
          xhr.send();
        });
      }
      // --- Cache
      /**
       * Cache keys prefix constant.
       * @const {string}
       */
      const CACHE_KEY_PREFIX = 'cylc.progress.cached.';
      /**
       * Cache timeout constant (in seconds).
       * @const {number}
       */
      const CACHE_TIMEOUT_SECONDS = 60 * 60; /* 1 hour, 60 minutes times 60 seconds */
      /**
       * A cache that uses the browser LocalStorage. Values are stored for
       * a limit timeout. Once this timeout expires, the value is removed
       * from the cache and null is returned.
       */
      class Cache {
        /**
         * @param {number} timeout - The cache timeout expiration in seconds.
         */
        constructor(timeout) {
          this.timeout = timeout;
          this.storage = window.localStorage;
        }
        /**
         * Simply puts the value in the LocalStorage, replacing any previous value.
         * @param {string} key - The cache key.
         * @param {string} value - The value to be cached. This value will be serialized as a JSON string.
         */
        put(key, value) {
          const cached = {
            value: value,
            created: new Date().getTime()
          };
          // we always store strings in the LocalStorage, that is the reason for the JSON.stringify call
          this.storage.setItem(`${CACHE_KEY_PREFIX}${key}`, JSON.stringify(cached));
        }
        /**
         * Get the cached value if in the cache and not expired. Otherwise returns null.
         * @param {string} key - The cache key.
         * @returns {(null|Object)} Either the value cached, or null if nothing was found.
         */
        get(key) {
          try {
            const cachedJson = this.storage.getItem(`${CACHE_KEY_PREFIX}${key}`);
            if (cachedJson === null || cachedJson === undefined) {
              return null;
            }
            const cached = JSON.parse(cachedJson);
            const created = cached.created;
            const now = new Date().getTime(); // ms
            const expired = created + (this.timeout * 1000) <= now;
            // still valid, return it immediately
            if (!expired) {
              return cached.value;
            }
            // expired, remove from cache
            this.storage.removeItem(`${CACHE_KEY_PREFIX}${key}`);
            return null;
          } catch (e) {
            // e.g. SecurityError if using file:///...
            console.error(e);
            return null;
          }
        }
      }
      /**
       * A cache to prevent hitting the GitHub API unnecessarily.
       * @const {Cache}
       */
      const CACHE = new Cache(/* timeout in seconds */ CACHE_TIMEOUT_SECONDS);


      // --- Progress

      /**
       * Get the next release from a set of milestones. The next release is the milestone with the earliest due date.
       * @param {Array} milestones - array of milestone objects
       * @return {Object} The milestone with the earliest due date, or null if milestones empty.
       */
      function getNextRelease(milestones) {
          // Sort the milestones by due date
          if (!milestones) {
            console.error("Invalid milestones value");
            return null;
          }
          if (milestones instanceof Object) {
            // GitHub API returns {documentation_url: "", message: ""} messages for rate limiting
            // see https://developer.github.com/v3/#rate-limiting
            // and https://github.com/cylc/cylc.github.io/issues/15
            if (Object.prototype.hasOwnProperty.call(milestones, 'message')) {
              console.error(milestones.message)
              return null;
            }
          }
          milestones.sort((a, b) => a.due_on < b.due_on ? -1 : a.due_on > b.due_on ? 1 : 0);
          return milestones[0];
      }
      /**
       * Populate progress elements in the DOM.
       *
       * @param {number} openIssues - An integer with the number of open issues.
       * @param {number} closedIssues: An integer with the number of closed issues.
       * @param {string} title - The title of the next release.
       * @param {string} link - A URL link to the next release.
        */
      function populateProgress(openIssues, closedIssues, title, link) {
          const workProgress = closedIssues * 100 / (openIssues + closedIssues);

          const milestoneVersion = document.getElementById("milestone-version");
          milestoneVersion.innerHTML = title;

          const milestoneURL = document.getElementById("milestone-url");
          milestoneURL.setAttribute('href', link);

          const progressBarInner = document.getElementById("progress");
          progressBarInner.style.width = workProgress + "%";

          const progress = document.getElementById("progress-info");
          progress.innerHTML = Math.floor(workProgress) + "%";

          const milestoneContainer = document.getElementById("milestone-container");
          milestoneContainer.style.opacity = "1";
          milestoneContainer.style.transition = ".7s ease-in";
      }

      /**
       * @param {Object} milestones - The list of milestones.
       */
      function showProgress(milestones) {
        const nextRelease = getNextRelease(milestones);
        if (nextRelease) {
          const openIssues = nextRelease.open_issues;
          const closedIssues = nextRelease.closed_issues;
          const title = nextRelease.title;
          const link = nextRelease.html_url.replace('s/next%20release', '/' + nextRelease.number);
          populateProgress(openIssues, closedIssues, title, link);
        }
      }

      /**
       * Retrieve the milestones (progress) of the project.
       * @return {Promise} A Promise object that populates and creates DOM elements, or returns the status text on error.
       */
      function retrieveProgress() {
        const milestones = CACHE.get('milestones');
        if (milestones !== null) {
          return new Promise(function () {
            showProgress(milestones);
          })
        } else {
          // fetch from GitHub API
          return doGet(MILESTONES_URL).then(function (milestones) {
            CACHE.put('milestones', milestones);
            showProgress(milestones);
          })
        }
      }

      // --- Releases

      /**
       * Populate HTML elements with information about the latest release.
       *
       * @param cylcx {string} - 'cylc8' or 'cylc7'
       * @param name {string} -  name of the release
       * @param link {string} - URL of the release
       * @param publishedAt {string} - raw text date as returned from the API
       */
      function populateLatestReleaseInformation(cylcx, name, link, publishedAt) {
        const latestReleaseName = document.getElementById(cylcx + "-latest-release-name");
        latestReleaseName.innerHTML = name;

        const latestReleaseURL = document.getElementById(cylcx + "-button");
        latestReleaseURL.href = link;

        const latestReleaseDateText = document.getElementById(cylcx + "-latest-release-pubdate-text");
        latestReleaseDateText.innerHTML = `Released: ${publishedAt}`;
      }

      /**
       * @param {Array} releases - The list of releases.
       */
      function showReleases(releases) {
        // we only want to iterate over 15 releases...
        const min = Math.min(releases.length, 15);
        let foundCylc8Latest = false;
        let foundCylc7Latest = false;
        for (let i = 0; i < min; ++i) {
          const release = releases[i];
          const name = release.name;
          const publishedAt = new Date(release.published_at).toLocaleString().split(',')[0];
          const link = TAGS_URL + release.tag_name;
          // display latest release metadata
          if (name.startsWith("cylc-7.8")) {
            populateLatestReleaseInformation("cylc7", name, link, publishedAt);
            foundCylc7Latest = true;
          } else if (name.startsWith("cylc-flow-8")) {
            populateLatestReleaseInformation("cylc8", name, link, publishedAt);
            foundCylc8Latest = true;
          }
          if (foundCylc7Latest === true && foundCylc8Latest === true) {
            break;
          }
        }
      }

      /**
       * Retrieve the releases of the project.
       * @return {Promise} A Promise object that populates and creates DOM elements, or returns the status text on error.
       */
      function retrieveReleases() {
        const releases = CACHE.get('releases');
        if (releases !== null) {
          return new Promise(function () {
            showReleases(releases);
          })
        } else {
          return doGet(RELEASES_URL).then(function (releases) {
            CACHE.put('releases', releases);
            showReleases(releases);
          })
        }
      }

      // --- window.onload

      /**
       * Called when the browser loads the page. It will execute two promises asynchronously,
       * one to retrieve the progress, and the other to retrieve the releases.
       * If an error occurs, it will print the error to the browser console.
       */
      window.onload = function () {
        Promise.all([
          retrieveProgress(),
          retrieveReleases()
        ])
          .catch(function(error) {
            // Any error propagated here will be logged to the browser console
            console.log(error);
          });
      };
      </script>

  </body>

</html>
